#要改日期
import yfinance as yf
import pandas as pd
from pymongo import MongoClient

# 設置 MongoDB 連接
client = MongoClient('mongodb://localhost:27017/')
db = client['test']
collection = db['price']

# 定義股票代號
tickers = ['1101.TW', '1102.TW', '1103.TW', '1104.TW', '1108.TW', '1109.TW', '1110.TW', '1201.TW', '1203.TW', '1210.TW', '1213.TW', '1215.TW', '1216.TW', '1217.TW', '1218.TW', '1219.TW', '1220.TW', '1225.TW', '1227.TW', '1229.TW', '1231.TW', '1232.TW', '1233.TW', '1234.TW', '1235.TW', '1236.TW', '1256.TW', '1301.TW', '1303.TW', 
'1304.TW', '1305.TW', '1307.TW', '1308.TW', '1309.TW', '1310.TW', '1312.TW', '1313.TW', '1314.TW', '1315.TW', '1316.TW', '1319.TW', '1321.TW', '1323.TW', '1324.TW', '1325.TW', '1326.TW', '1337.TW', '1338.TW', '1339.TW', '1340.TW', '1341.TW', '1342.TW', '1402.TW', '1409.TW', '1410.TW', '1413.TW', '1414.TW', '1416.TW', '1417.TW', '1418.TW', '1419.TW', '1423.TW', '1432.TW', '1434.TW', '1435.TW', '1436.TW', '1437.TW', '1438.TW', '1439.TW', '1440.TW', '1441.TW', '1442.TW', '1443.TW', '1444.TW', '1445.TW', '1446.TW', '1447.TW', '1449.TW', '1451.TW', '1452.TW', '1453.TW', '1454.TW', '1455.TW', '1456.TW', '1457.TW', '1459.TW', '1460.TW', '1463.TW', '1464.TW', '1465.TW', '1466.TW', '1467.TW', '1468.TW', '1470.TW', '1471.TW', '1472.TW', '1473.TW', '1474.TW', '1475.TW', '1476.TW', '1477.TW', '1503.TW', '1504.TW', '1506.TW', '1512.TW', '1513.TW', '1514.TW', '1515.TW', '1516.TW', '1517.TW', '1519.TW', '1521.TW', '1522.TW', '1524.TW', '1525.TW', '1526.TW', '1527.TW', '1528.TW', '1529.TW', '1530.TW', '1531.TW', '1532.TW', '1533.TW', '1535.TW', '1536.TW', '1537.TW', '1538.TW', '1539.TW', '1540.TW', '1541.TW', '1558.TW', '1560.TW', '1568.TW', '1582.TW', '1583.TW', '1587.TW', '1589.TW', '1590.TW', '1597.TW', '1598.TW', '1603.TW', '1604.TW', '1605.TW', '1608.TW', '1609.TW', '1611.TW', '1612.TW', '1614.TW', '1615.TW', '1616.TW', '1617.TW', '1618.TW', '1626.TW', '1701.TW', '1702.TW', '1707.TW', '1708.TW', '1709.TW', '1710.TW', '1711.TW', '1712.TW', '1713.TW', '1714.TW', '1717.TW', '1718.TW', '1720.TW', '1721.TW', '1722.TW', '1723.TW', '1725.TW', '1726.TW', '1727.TW', '1730.TW', '1731.TW', '1732.TW', '1733.TW', '1734.TW', '1735.TW', '1736.TW', '1737.TW', '1752.TW', '1760.TW', '1762.TW', '1773.TW', '1776.TW', '1783.TW', '1786.TW', '1789.TW', '1795.TW', 
'1802.TW', '1805.TW', '1806.TW', '1808.TW', '1809.TW', '1810.TW', '1817.TW', '1903.TW', '1904.TW', '1905.TW', '1906.TW', '1907.TW', '1909.TW', '2002.TW', '2006.TW', '2007.TW', '2008.TW', '2009.TW', '2010.TW', '2012.TW', '2013.TW', '2014.TW', '2015.TW', '2017.TW', '2020.TW', '2022.TW', '2023.TW', '2024.TW', '2025.TW', '2027.TW', '2028.TW', '2029.TW', '2030.TW', '2031.TW', '2032.TW', '2033.TW', '2034.TW', '2038.TW', '2049.TW', '2059.TW', '2062.TW', '2069.TW', '2101.TW', '2102.TW', '2103.TW', '2104.TW', '2105.TW', '2106.TW', '2107.TW', '2108.TW', '2109.TW', '2114.TW', '2115.TW', '2201.TW', '2204.TW', '2206.TW', '2207.TW', '2208.TW', '2211.TW', '2227.TW', '2228.TW', '2231.TW', '2233.TW', '2236.TW', '2239.TW', '2241.TW', '2243.TW', '2247.TW', '2250.TW', '2301.TW', '2302.TW', '2303.TW', '2305.TW', '2308.TW', '2312.TW', '2313.TW', '2314.TW', '2316.TW', '2317.TW', '2321.TW', '2323.TW', '2324.TW', '2327.TW', '2328.TW', '2329.TW', '2330.TW', '2331.TW', '2332.TW', '2337.TW', '2338.TW', '2340.TW', '2342.TW', '2344.TW', '2345.TW', '2347.TW', '2348.TW', '2349.TW', '2351.TW', '2352.TW', '2353.TW', '2354.TW', '2355.TW', '2356.TW', '2357.TW', '2358.TW', '2359.TW', '2360.TW', '2362.TW', '2363.TW', '2364.TW', '2365.TW', '2367.TW', '2368.TW', '2369.TW', '2371.TW', '2373.TW', '2374.TW', '2375.TW', '2376.TW', '2377.TW', '2379.TW', '2380.TW', '2382.TW', '2383.TW', '2385.TW', '2387.TW', '2388.TW', '2390.TW', '2392.TW', '2393.TW', '2395.TW', '2397.TW', '2399.TW', '2401.TW', '2402.TW', '2404.TW', '2405.TW', '2406.TW', '2408.TW', '2409.TW', '2412.TW', '2413.TW', '2414.TW', '2415.TW', '2417.TW', '2419.TW', '2420.TW', '2421.TW', '2423.TW', '2424.TW', '2425.TW', '2426.TW', '2427.TW', '2428.TW', '2429.TW', '2430.TW', '2431.TW', '2433.TW', '2434.TW', '2436.TW', 
'2438.TW', '2439.TW', '2440.TW', '2441.TW', '2442.TW', '2443.TW', '2444.TW', '2449.TW', '2450.TW', '2451.TW', '2453.TW', '2454.TW', '2455.TW', '2457.TW', '2458.TW', '2459.TW', '2460.TW', '2461.TW', '2462.TW', '2464.TW', '2465.TW', '2466.TW', '2467.TW', '2468.TW', '2471.TW', '2472.TW', '2474.TW', '2476.TW', '2477.TW', '2478.TW', '2480.TW', '2481.TW', '2482.TW', '2483.TW', '2484.TW', '2485.TW', '2486.TW', '2488.TW', '2489.TW', '2491.TW', '2492.TW', '2493.TW', '2495.TW', '2496.TW', '2497.TW', '2498.TW', '2501.TW', '2504.TW', '2505.TW', '2506.TW', '2509.TW', '2511.TW', '2514.TW', '2515.TW', '2516.TW', '2520.TW', '2524.TW', '2527.TW', '2528.TW', '2530.TW', '2534.TW', '2535.TW', '2536.TW', '2537.TW', '2538.TW', '2539.TW', '2540.TW', '2542.TW', '2543.TW', '2545.TW', '2546.TW', '2547.TW', '2548.TW', '2597.TW', '2601.TW', '2603.TW', '2605.TW', '2606.TW', '2607.TW', '2608.TW', '2609.TW', '2610.TW', '2611.TW', '2612.TW', '2613.TW', '2614.TW', '2615.TW', '2616.TW', '2617.TW', '2618.TW', '2630.TW', '2633.TW', '2634.TW', '2636.TW', '2637.TW', '2642.TW', '2645.TW', '2701.TW', '2702.TW', '2704.TW', '2705.TW', '2706.TW', '2707.TW', '2712.TW', '2722.TW', '2723.TW', '2727.TW', '2731.TW', '2739.TW', '2748.TW', '2753.TW', '2762.TW', '2801.TW', '2809.TW', '2812.TW', '2816.TW', '2820.TW', '2832.TW', '2834.TW', '2836.TW', '2838.TW', '2845.TW', '2849.TW', '2850.TW', '2851.TW', '2852.TW', '2855.TW', '2867.TW', '2880.TW', '2881.TW', '2882.TW', '2883.TW', '2884.TW', '2885.TW', '2886.TW', '2887.TW', '2888.TW', '2889.TW', '2890.TW', '2891.TW', '2892.TW', '2897.TW', '2901.TW', '2903.TW', '2904.TW', '2905.TW', '2906.TW', '2908.TW', '2910.TW', '2911.TW', '2912.TW', '2913.TW', '2915.TW', '2923.TW', '2929.TW', '2939.TW', '2945.TW', '3002.TW', '3003.TW', '3004.TW', 
'3005.TW', '3006.TW', '3008.TW', '3010.TW', '3011.TW', '3013.TW', '3014.TW', '3015.TW', '3016.TW', '3017.TW', '3018.TW', '3019.TW', '3021.TW', '3022.TW', '3023.TW', '3024.TW', '3025.TW', '3026.TW', '3027.TW', '3028.TW', '3029.TW', '3030.TW', '3031.TW', '3032.TW', '3033.TW', '3034.TW', '3035.TW', '3036.TW', '3037.TW', '3038.TW', '3040.TW', '3041.TW', '3042.TW', '3043.TW', '3044.TW', '3045.TW', '3046.TW', '3047.TW', '3048.TW', '3049.TW', '3050.TW', '3051.TW', '3052.TW', '3054.TW', '3055.TW', '3056.TW', '3057.TW', '3058.TW', '3059.TW', '3060.TW', '3062.TW', '3090.TW', '3092.TW', '3094.TW', '3130.TW', '3138.TW', '3149.TW', '3164.TW', '3167.TW', '3189.TW', '3209.TW', '3229.TW', '3231.TW', '3257.TW', '3266.TW', '3296.TW', '3305.TW', '3308.TW', '3311.TW', '3312.TW', '3321.TW', '3338.TW', '3346.TW', '3356.TW', '3376.TW', '3380.TW', '3406.TW', '3413.TW', '3416.TW', '3419.TW', '3432.TW', '3437.TW', '3443.TW', '3447.TW', '3450.TW', '3454.TW', '3481.TW', '3494.TW', '3501.TW', '3504.TW', '3515.TW', '3518.TW', '3528.TW', '3530.TW', '3532.TW', '3533.TW', '3535.TW', '3543.TW', '3545.TW', '3550.TW', '3557.TW', '3563.TW', '3576.TW', '3583.TW', '3588.TW', '3591.TW', '3592.TW', '3593.TW', '3596.TW', '3605.TW', '3607.TW', '3617.TW', '3622.TW', '3645.TW', '3652.TW', '3653.TW', '3661.TW', '3665.TW', '3669.TW', '3673.TW', '3679.TW', '3686.TW', '3694.TW', '3701.TW', '3702.TW', '3703.TW', '3704.TW', '3705.TW', '3706.TW', '3708.TW', '3711.TW', '3712.TW', '3714.TW', '3715.TW', '4104.TW', '4106.TW', '4108.TW', '4119.TW', '4133.TW', '4137.TW', '4142.TW', '4148.TW', '4155.TW', '4164.TW', '4190.TW', '4306.TW', '4414.TW', '4426.TW', '4438.TW', '4439.TW', '4440.TW', '4526.TW', '4532.TW', '4536.TW', '4540.TW', '4545.TW', '4551.TW', '4552.TW', '4555.TW', '4557.TW', 
'4560.TW', '4562.TW', '4564.TW', '4566.TW', '4569.TW', '4571.TW', '4572.TW', '4576.TW', '4581.TW', '4583.TW', '4588.TW', '4720.TW', '4722.TW', '4736.TW', '4737.TW', '4739.TW', '4746.TW', '4755.TW', '4763.TW', '4764.TW', '4766.TW', '4770.TW', '4807.TW', '4904.TW', '4906.TW', '4912.TW', '4915.TW', '4916.TW', '4919.TW', '4927.TW', '4930.TW', '4934.TW', '4935.TW', '4938.TW', '4942.TW', '4943.TW', '4952.TW', '4956.TW', '4958.TW', '4960.TW', '4961.TW', '4967.TW', '4968.TW', '4976.TW', '4977.TW', '4989.TW', '4994.TW', '4999.TW', '5007.TW', '5203.TW', '5215.TW', '5222.TW', '5225.TW', '5234.TW', '5243.TW', '5244.TW', '5258.TW', '5269.TW', '5283.TW', '5284.TW', '5285.TW', '5288.TW', '5292.TW', '5306.TW', '5388.TW', '5434.TW', '5469.TW', '5471.TW', '5484.TW', '5515.TW', '5519.TW', '5521.TW', '5522.TW', '5525.TW', '5531.TW', '5533.TW', '5534.TW', '5538.TW', '5546.TW', '5607.TW', '5608.TW', '5706.TW', '5871.TW', '5876.TW', '5880.TW', '5906.TW', '5907.TW', '6005.TW', '6024.TW', '6108.TW', '6112.TW', '6115.TW', '6116.TW', '6117.TW', '6120.TW', '6128.TW', '6133.TW', '6136.TW', '6139.TW', '6141.TW', '6142.TW', '6152.TW', '6153.TW', '6155.TW', '6164.TW', '6165.TW', '6166.TW', '6168.TW', '6176.TW', '6177.TW', '6183.TW', '6184.TW', '6189.TW', '6191.TW', '6192.TW', '6196.TW', '6197.TW', '6201.TW', '6202.TW', '6205.TW', '6206.TW', '6209.TW', '6213.TW', '6214.TW', '6215.TW', '6216.TW', '6224.TW', '6225.TW', '6226.TW', '6230.TW', '6235.TW', '6239.TW', '6243.TW', '6257.TW', '6269.TW', '6271.TW', '6277.TW', '6278.TW', '6281.TW', '6282.TW', '6283.TW', '6285.TW', '6288.TW', '6405.TW', '6409.TW', '6412.TW', '6414.TW', '6415.TW', '6416.TW', '6426.TW', '6431.TW', '6438.TW', '6442.TW', '6443.TW', '6446.TW', '6449.TW', '6451.TW', '6456.TW', '6464.TW', '6472.TW', 
'6477.TW', '6491.TW', '6504.TW', '6505.TW', '6515.TW', '6525.TW', '6526.TW', '6531.TW', '6533.TW', '6541.TW', '6550.TW', '6552.TW', '6558.TW', '6573.TW', '6579.TW', '6581.TW', '6582.TW', '6585.TW', '6591.TW', '6592.TW', '6598.TW', '6605.TW', '6606.TW', '6625.TW', '6641.TW', '6655.TW', '6657.TW', '6658.TW', '6666.TW', '6668.TW', '6669.TW', '6670.TW', '6671.TW', '6672.TW', '6674.TW', '6689.TW', '6691.TW', '6695.TW', '6698.TW', '6706.TW', '6715.TW', '6719.TW', '6742.TW', '6743.TW', '6753.TW', '6754.TW', '6756.TW', '6768.TW', '6770.TW', '6776.TW', '6781.TW', '6782.TW', '6789.TW', '6790.TW', '6792.TW', '6796.TW', '6799.TW', '6805.TW', '6806.TW', '6807.TW', '6830.TW', '6834.TW', '6835.TW', '6861.TW', '6863.TW', '6901.TW', '6906.TW', '6916.TW', '6933.TW', '6937.TW', '8011.TW', '8016.TW', '8021.TW', '8028.TW', '8033.TW', '8039.TW', '8046.TW', '8070.TW', '8072.TW', '8081.TW', '8101.TW', '8103.TW', '8104.TW', '8105.TW', '8110.TW', '8112.TW', '8114.TW', '8131.TW', '8150.TW', '8163.TW', '8201.TW', '8210.TW', '8213.TW', '8215.TW', '8222.TW', '8249.TW', '8261.TW', '8271.TW', '8341.TW', '8367.TW', '8374.TW', '8404.TW', '8411.TW', '8422.TW', '8429.TW', '8438.TW', '8442.TW', '8443.TW', '8454.TW', '8462.TW', '8463.TW', '8464.TW', '8466.TW', '8467.TW', '8473.TW', '8476.TW', '8478.TW', '8481.TW', '8482.TW', '8488.TW', '8499.TW', '8926.TW', '8940.TW', '8996.TW', '9802.TW', '9902.TW', '9904.TW', '9905.TW', '9906.TW', '9907.TW', '9908.TW', '9910.TW', '9911.TW', '9912.TW', '9914.TW', '9917.TW', '9918.TW', '9919.TW', '9921.TW', '9924.TW', '9925.TW', '9926.TW', '9927.TW', '9928.TW', '9929.TW', '9930.TW', '9931.TW', '9933.TW', '9934.TW', '9935.TW', '9937.TW', '9938.TW', '9939.TW', '9940.TW', '9941.TW', '9942.TW', '9943.TW', '9944.TW', '9945.TW', '9946.TW', '9955.TW', '9958.TW']

# 抓取資料
data = yf.download(tickers, start='2024-11-29', end='2024-12-10', interval='1d', group_by='ticker')

# 遍歷每個股票，存入每日數據
for ticker in tickers:
    ticker_clean = ticker.replace('.TW', '')  # 移除.TW

    ticker_data = data[ticker]
    if ticker_data.empty:
        continue

    # 遍歷每個日期的數據
    for index, row in ticker_data.iterrows():
        # 格式化日期為 'YYYY-MM-DD'
        date_str = index.strftime('%Y-%m-%d')

        open_price = row['Open']
        high_price = row['High']
        low_price = row['Low']
        close_price = row['Close']

        if pd.isna(open_price) and pd.isna(high_price) and pd.isna(low_price) and pd.isna(close_price):
            # 如果四個價格都為缺失值，跳過該日期
            continue

        # 構建要插入的字典，包括開、高、低、收價
        stock_data = {
            "code": ticker_clean,
            "date": date_str,
            "open": round(open_price, 1) if pd.notna(open_price) else None,
            "high": round(high_price, 1) if pd.notna(high_price) else None,
            "low": round(low_price, 1) if pd.notna(low_price) else None,
            "close": round(close_price, 1) if pd.notna(close_price) else None
            # 暫時不包括其他計算值
        }

        collection.update_one(
            {'code': ticker_clean, 'date': date_str},
            {'$set': stock_data},
            upsert=True
        )
    print(f"股票 {ticker_clean} 的每日數據處理完成")

print("每日開高收低數據已成功插入 MongoDB")

# 從資料庫中計算並更新其他欄位
tickers_clean = [ticker.replace('.TW', '') for ticker in tickers]

for ticker in tickers_clean:
    # 從資料庫中獲取該股票的所有資料，按日期排序
    cursor = collection.find({'code': ticker}).sort('date', 1)
    data = pd.DataFrame(list(cursor))

    if data.empty:
        continue

    # 確保日期是 datetime 格式
    data['date'] = pd.to_datetime(data['date'])

    # 按日期排序
    data = data.sort_values('date')

    # 計算前一天的收盤價
    data['previous_close'] = data['close'].shift(1)

    # 計算價差和漲跌幅
    data['price_change'] = data['close'] - data['previous_close']
    data['changed_percent'] = (data['price_change'] / data['previous_close']) * 100

    # 計算移動平均線
    data['5dma'] = data['close'].rolling(window=5).mean()
    data['10dma'] = data['close'].rolling(window=10).mean()
    data['20dma'] = data['close'].rolling(window=20).mean()
    data['60dma'] = data['close'].rolling(window=60).mean()

    # 更新資料庫
    for index, row in data.iterrows():
        update_fields = {}
        if pd.notna(row['previous_close']):
            update_fields['previous_close'] = round(row['previous_close'], 1)
        if pd.notna(row['price_change']):
            update_fields['price_change'] = round(row['price_change'], 1)
        if pd.notna(row['changed_percent']):
            update_fields['changed_percent'] = round(row['changed_percent'], 2)
        if pd.notna(row['5dma']):
            update_fields['5dma'] = round(row['5dma'], 1)
        if pd.notna(row['10dma']):
            update_fields['10dma'] = round(row['10dma'], 1)
        if pd.notna(row['20dma']):
            update_fields['20dma'] = round(row['20dma'], 1)
        if pd.notna(row['60dma']):
            update_fields['60dma'] = round(row['60dma'], 1)

        if update_fields:
            collection.update_one(
                {'code': ticker, 'date': row['date'].strftime('%Y-%m-%d')},
                {'$set': update_fields}
            )
    print(f"股票 {ticker} 的技術指標計算完成")

print("價差、漲跌幅和移動平均線已更新到資料庫")

